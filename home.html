<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <title>×“×£ ×”×‘×™×ª</title>
    <link rel="stylesheet" href="style2.css">
</head>

<body>

    <header class="top-bar">
        <a href="https://www.flaticon.com/free-icons/recipe" title="recipe icons" target="_blank">
            <img src="images/cooking.png" alt="×œ×•×’×•" class="logo" />
        </a>

        <div id="topBar">
            <div id="userInfo">
                <img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="User Icon">
                <span id="userEmail">×©×œ×•×</span>
                <div id="logoutMenu" class="hidden">
                    <button id="logoutBtn">ğŸšª ×™×¦×™××”</button>
                </div>
            </div>
        </div>



        <input type="text" id="searchInput" placeholder="×—×¤×© ××ª×›×•×Ÿ..." onkeydown="handleSearchKey(event)"
            style="padding: 8px; border-radius: 8px; border: 1px solid #ccc; margin-right: 70px;" />

        <button class="add-recipe-btn" onclick="window.location.href='add-recipe.html'">
            â• ×”×•×¡×£ ××ª×›×•×Ÿ
        </button>
    </header>

    <div id="content"></div>

    <p id="userEmail"></p>

    <!-- ×›××Ÿ ×™×•×¤×™×¢×• ×”××ª×›×•× ×™× -->
    <div id="recipeList" style="padding: 30px;"></div>




    <p id="error"></p>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://izpbbjhikbbbyahxzhkg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6cGJiamhpa2JiYnlhaHh6aGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTMxMDUsImV4cCI6MjA2Mzc2OTEwNX0.Gv0WaUlkUAW1qBNEaaXDCWWpwWgbvBTya8KQzFhx08s'; // ×©×™× ××ª ×”××¤×ª×— ×”××œ× ×©×œ×š ×¤×”

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            },
            global: {
                headers: {
                    apikey: SUPABASE_KEY
                }
            }
        });


        checkSession();

        function handleSearchKey(e) {
            if (e.key === "Enter") {
                const query = e.target.value.toLowerCase();
                const recipes = document.querySelectorAll(".recipe");

                recipes.forEach((recipe) => {
                    const title = recipe.querySelector(".recipe-title").textContent.toLowerCase();
                    recipe.style.display = title.includes(query) ? "block" : "none";
                });
            }
        }

        async function loadRecipes() {
            const { data, error } = await supabase
                .from("recipes")
                .select("*");

            console.log("ğŸ“‹ ×›×œ ×”××ª×›×•× ×™× ×‘×˜×‘×œ×” (×›×•×œ×œ is_approved false):", data);

            if (error) {
                console.error("âŒ ×©×’×™××” ×‘×§×‘×œ×ª ××ª×›×•× ×™×:", error);
                return;
            }

            const approved = data.filter(recipe => recipe.is_approved === true);
            console.log("âœ… ×¨×§ ×”××ª×›×•× ×™× ×”×××•×©×¨×™×:", approved);

            const list = document.getElementById("recipeList");
            list.innerHTML = "";

            if (approved.length === 0) {
                list.innerHTML = "<p>âš ï¸ ××™×Ÿ ×¢×“×™×™×Ÿ ××ª×›×•× ×™× ×××•×©×¨×™× ×œ×”×¦×’×”.</p>";
                return;
            }

            approved.forEach((recipe) => {
                const preview = document.createElement("div");
                preview.classList.add("recipe-preview");
                preview.innerHTML = `<button class="recipe-button">${recipe.title || "×œ×œ× ×›×•×ª×¨×ª"}</button>`;

                const full = document.createElement("div");
                full.classList.add("recipe-full");
                full.innerHTML = `
      <div class="recipe-content">
        <div class="recipe-text">
          <div><strong>×›×•×ª×¨×ª:</strong> <div class="recipe-title">${recipe.title || "×œ×œ× ×›×•×ª×¨×ª"}</div></div>
          <div><strong>×ª×™××•×¨:</strong> <div class="recipe-description">${recipe.description || "××™×Ÿ ×ª×™××•×¨ ×œ××ª×›×•×Ÿ"}</div></div>
        </div>
        <div class="recipe-images">
          ${recipe.image1_url ? `<img src="${recipe.image1_url}" class="recipe-img">` : ""}
          ${recipe.image2_url ? `<img src="${recipe.image2_url}" class="recipe-img">` : ""}
          ${recipe.image3_url ? `<img src="${recipe.image3_url}" class="recipe-img">` : ""}
        </div>
      </div>
    `;

                full.style.display = "none"; // ××•×¡×ª×¨ ×‘×”×ª×—×œ×”

                preview.querySelector("button").addEventListener("click", () => {
                    full.style.display = full.style.display === "none" ? "block" : "none";
                });

                list.prepend(full);
                list.prepend(preview);

            });

        }


        const { data, error } = await supabase
            .from("recipes")
            .select("id, title, is_approved");

        console.log("ğŸ“‹ ×›×œ ×”××ª×›×•× ×™× ×‘×˜×‘×œ×”:", data);


        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                alert("×”×—×™×‘×•×¨ ×©×œ×š ×¤×’ ×ª×•×§×£ ××• ×©××™× ×š ××—×•×‘×¨");
                window.location.href = "index.html";
                return;
            }

            const fullEmail = session.user.email;
            const shortEmail = fullEmail.length > 8
                ? fullEmail.substring(0, 5) + "..."
                : fullEmail;

            document.getElementById("userEmail").textContent = `×©×œ×•×, ${shortEmail}`;
            console.log("××©×ª××© ××—×•×‘×¨:", session.user.email);

            // â¬…ï¸ ×§×¨×™××” ××—×¨×™ ×©×”×¤×•× ×§×¦×™×” ×§×™×™××ª
            loadRecipes();
        }

        checkSession();

        // ×‘×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×™×¦×™××” â€“ × ×‘×¦×¢ signOut
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await supabase.auth.signOut();
            window.location.href = "index.html"; // ×—×–×¨×” ×œ×¢××•×“ ×”×¨××©×™
        });

        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await supabase.auth.signOut();
            localStorage.clear(); // ××•×—×§ ×›×œ ××” ×©× ×©××¨
            sessionStorage.clear(); // ×× ×”×©×ª××©×ª ×’× ×‘×–×”
            window.location.href = "index.html";
        });

    </script>

</body>

</html>